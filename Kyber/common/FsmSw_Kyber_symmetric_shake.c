/***********************************************************************************************************************
*
*                                          IAV GmbH
*
***********************************************************************************************************************/
/*
 *
 *  $File$
 *
 *  $Author$
 *
 *  $Date$
 *
 *  $Rev$
 *
 **********************************************************************************************************************/

/**********************************************************************************************************************/
/* INCLUDES                                                                                                           */
/**********************************************************************************************************************/
#include "FsmSw_Types.h"
#include "FsmSw_CommonLib.h"
#include "FsmSw_Fips202.h"
#include "FsmSw_Kyber_params.h"
#include "FsmSw_Kyber_symmetric.h"

/**********************************************************************************************************************/
/* DEFINES                                                                                                            */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* TYPES                                                                                                              */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* GLOBAL VARIABLES                                                                                                   */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* MACROS                                                                                                             */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* PRIVATE FUNCTION PROTOTYPES                                                                                        */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* PRIVATE FUNCTIONS DEFINITIONS                                                                                      */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* PUBLIC FUNCTIONS DEFINITIONS                                                                                       */
/**********************************************************************************************************************/
/***********************************************************************************************************************
* Name:        FsmSw_Kyber_shake128_absorb
*
* Description: Absorb step of the SHAKE128 specialized for the Kyber context.
*
* Arguments:   -       xof_state *s:     pointer to (uninitialized) output Keccak state
*              - const uint8     *seed:  pointer to KYBER_SYMBYTES input to be absorbed into state
*              -       uint8      i:     additional byte of input
*              -       uint8      j:     additional byte of input
***********************************************************************************************************************/
void FsmSw_Kyber_shake128_absorb(xof_state *s, const uint8 seed[KYBER_SYMBYTES], uint8 x, uint8 y)
{
    uint8 extseed[KYBER_SYMBYTES + 2u];

    FsmSw_CommonLib_memcpy(extseed, seed, KYBER_SYMBYTES);
    extseed[KYBER_SYMBYTES] = x;
    extseed[KYBER_SYMBYTES + 1u] = y;

    FsmSw_Fips202_shake128_absorb(s, extseed, sizeof(extseed));
}

/***********************************************************************************************************************
* Name:        FsmSw_Kyber_shake256_prf
*
* Description: Usage of SHAKE256 as a PRF, concatenates secret and public input
*              and then generates outlen bytes of SHAKE256 output
*
* Arguments:   -       uint8  *out:    pointer to output
*              -       uint32  outlen: number of requested output bytes
*              - const uint8  *key:    pointer to the key (of length KYBER_SYMBYTES)
*              -       uint8   nonce:  single-byte nonce (public PRF input)
***********************************************************************************************************************/
void FsmSw_Kyber_shake256_prf(uint8 *out, uint32 outlen, const uint8 key[KYBER_SYMBYTES], uint8 nonce)
{
    uint8 extkey[KYBER_SYMBYTES + 1u];

    FsmSw_CommonLib_memcpy(extkey, key, KYBER_SYMBYTES);
    extkey[KYBER_SYMBYTES] = nonce;

    FsmSw_Fips202_shake256(out, outlen, extkey, sizeof(extkey));
}
