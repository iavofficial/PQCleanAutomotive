/***********************************************************************************************************************
*
*                                          IAV GmbH
*
***********************************************************************************************************************/
/*
 *
 *  $File$
 *
 *  $Author$
 *
 *  $Date$
 *
 *  $Rev$
 *
 **********************************************************************************************************************/

/**********************************************************************************************************************/
/* INCLUDES                                                                                                           */
/**********************************************************************************************************************/
#include "FsmSw_Dilithium5_params.h"
#include "FsmSw_Dilithium5_rounding.h"

/**********************************************************************************************************************/
/* DEFINES                                                                                                            */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* TYPES                                                                                                              */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* GLOBAL VARIABLES                                                                                                   */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* MACROS                                                                                                             */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* PRIVATE FUNCTION PROTOTYPES                                                                                        */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* PRIVATE FUNCTIONS DEFINITIONS                                                                                      */
/**********************************************************************************************************************/

/**********************************************************************************************************************/
/* PUBLIC FUNCTIONS DEFINITIONS                                                                                       */
/**********************************************************************************************************************/
/***********************************************************************************************************************
* Name:        FsmSw_Dilithium5_power2round
*
* Description: For finite field element a, compute a0, a1 such that a mod^+ Q = a1*2^D + a0 with
*              -2^{D-1} < a0 <= 2^{D-1}. Assumes a to be standard representative.
*
* Arguments:   - sint32   a: input element
*              - sint32 *a0: pointer to output element a0
*
* Returns a1.
***********************************************************************************************************************/
sint32 FsmSw_Dilithium5_power2round(sint32 *a0, sint32 a)
{
    sint32 a1;
    sint32 temp;

    temp = (a + (sint32)4095u);
    a1   = (sint32)((uint32)((uint32)temp >> D_DILITHIUM));
    *a0  = a - (sint32)((uint32)((uint32)a1 << D_DILITHIUM));

    return a1;
}

/***********************************************************************************************************************
* Name:        FsmSw_Dilithium5_decompose
*
* Description: For finite field element a, compute high and low bits a0, a1 such that a mod^+ Q = a1*ALPHA + a0 with
*              -ALPHA/2 < a0 <= ALPHA/2 except if a1 = (Q-1)/ALPHA where we set a1 = 0 and
*              -ALPHA/2 <= a0 = a mod^+ Q - Q < 0. Assumes a to be standard representative.
*
* Arguments:   - sint32   a: input element
*              - sint32 *a0: pointer to output element a0
*
* Returns a1.
***********************************************************************************************************************/
sint32 FsmSw_Dilithium5_decompose(sint32 *a0, sint32 a)
{
    sint32 a1;
    sint32 temp1, temp2, temp3;

    a1  = (sint32)((uint32)(((uint32)a + 127u) >> 7));

    /* (1u << 21) = 2.097.152 */
    temp1 = (a1 * 1025 + (sint32)2097152u);
    a1 = (sint32)((uint32)((uint32)temp1 >> 22));
    a1 = (sint32)((uint32)((uint32)a1 & 15u));

    *a0  = a - a1 * 2 * GAMMA2_DILITHIUM5;
    temp2 = ((Q_DILITHIUM - 1) / 2 - *a0);
    temp3 = (sint32)((uint32)((uint64)temp2 >> 31));

    *a0 = *a0 - (sint32)((uint32)((uint32)temp3 & (uint32)Q_DILITHIUM));

    return a1;
}

/***********************************************************************************************************************
* Name:        FsmSw_Dilithium5_make_hint
*
* Description: Compute hint bit indicating whether the low bits of the input element overflow into the high bits.
*
* Arguments:   - sint32 a0: low bits of input element
*              - sint32 a1: high bits of input element
*
* Returns 1 if overflow.
***********************************************************************************************************************/
uint8 FsmSw_Dilithium5_make_hint(sint32 a0, sint32 a1)
{
    if (a0 > GAMMA2_DILITHIUM5 || a0 < -GAMMA2_DILITHIUM5 || (a0 == -GAMMA2_DILITHIUM5 && a1 != 0))
    {
        return 1;
    }

    return 0;
}

/***********************************************************************************************************************
* Name:        FsmSw_Dilithium5_use_hint
*
* Description: Correct high bits according to hint.
*
* Arguments:   - sint32 a:    input element
*              - uint32 hint: hint bit
*
* Returns corrected high bits.
***********************************************************************************************************************/
sint32 FsmSw_Dilithium5_use_hint(sint32 a, uint32 hint)
{
    sint32 a0, a1;

    a1 = FsmSw_Dilithium5_decompose(&a0, a);

    if (hint == 0u)
    {
        return a1;
    }

    if (a0 > 0)
    {
        return (sint32)((uint32)(((uint32)a1 + 1u) & 15u));
    }

    return (sint32)((uint32)(((uint32)a1 - 1u) & 15u));
}
